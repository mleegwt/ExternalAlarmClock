apply plugin: 'java'
apply plugin: 'kotlin'
apply plugin: 'application'
apply plugin: 'com.bmuschko.docker-java-application'

mainClassName = "com.externalalarmclock.alarmclock.AlarmClockApplicationKt"

project.ext {
    configPath = "$project.projectDir/src/dist/conf/"
}

run {
 args 'server', configPath + 'alarmclock.yml'
}

dependencies {
    compile 'io.dropwizard:dropwizard-core:1.3.9'
    compile 'com.google.guava:guava:27.1-jre'
    compile project(':lib.externalalarmclock')
    compile project(':test')
    compile 'de.spinscale.dropwizard:dropwizard-jobs-core:3.0.0'
    compile "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
}

repositories {
  mavenLocal()
}

sourceCompatibility = "1.8"
targetCompatibility = "1.8"

// UTF-8 should be standard by now. So use it!
[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'

// WORKAROUND: Adding extra source set to allow docker to include configuration file.
sourceSets {
    main {
         resources {
             srcDirs "src/main/resources", "src/dist/config"
         }
    }
}

docker {
    javaApplication {
        baseImage = 'arm32v6/openjdk:8-jre-alpine'
        maintainer = 'Michiel Leegwater <mleegwt@users.noreply.github.com>'
        ports = [ 8080 ]
        exec {
            defaultCommand "server", "/app/resources/alarmclock.yml"
            entryPoint "java", "-cp", "/app/resources:/app/classes:/app/libs/*", "$mainClassName"
        }
    }
}
assemble.dependsOn(dockerBuildImage)
